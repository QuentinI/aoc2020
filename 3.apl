Z←⎕FIO[49]'3.in'
R←{((⍴Z)⍴1,0×¯1↓⍳⍺)×(1+(≢∊Z[1])|⍵×((⌈(⍳⍴Z)÷⍺)-1))×'#'=Z}
E←{+/∊⍵={⍳⍴⍵}¨⍵}
E (1 R 3)
×/{E ⍵[1] R ⍵[2]}¨(1 1) (1 3) (1 5) (1 7) (2 1)
